<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VolleyballPro • Drabinka Playoff</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="/js/config.js"></script>
  <script src="/js/supabase.js"></script>
  <script src="/js/util.js"></script>
  <script src="/js/ui-shared.js"></script>
  <script src="/js/engine.js"></script>
  <script src="/js/state.js"></script>
  <style>
    :root {
      --bg: #070A12;
      --card: rgba(255,255,255,.05);
      --border: rgba(255,255,255,.10);
      --text: #EAF0FF;
      --muted: #9AA7C7;
      --accent: #6AE4FF;
      --accent2: #A56EFF;
      --ok: #2DFF9E;
      --gold: #FFD166;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      width: 1920px; height: 1080px;
      overflow: hidden;
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
    }

    body {
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(106,228,255,.12), transparent 60%),
        radial-gradient(900px 650px at 85% 20%, rgba(165,110,255,.10), transparent 55%),
        radial-gradient(1000px 600px at 50% 95%, rgba(45,255,158,.07), transparent 60%),
        #070A12;
    }

    /* ── LAYOUT ── */
    .viewport {
      width: 1920px; height: 1080px;
      display: flex;
      flex-direction: column;
      padding: 48px 56px 44px;
      gap: 28px;
    }

    /* ── HEADER ── */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .headerLeft {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .tournamentBadge {
      padding: 8px 20px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      font-size: 15px;
      font-weight: 700;
      letter-spacing: .4px;
      color: var(--muted);
      text-transform: uppercase;
    }
    .headerTitle {
      font-size: 32px;
      font-weight: 900;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--text);
    }
    .headerTitle span {
      color: var(--accent);
    }
    .headerClock {
      font-family: var(--mono);
      font-size: 18px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 1px;
    }

    /* ── BRACKET GRID ── */
    .bracketGrid {
      flex: 1;
      display: grid;
      grid-template-columns: 2fr 1.4fr 1fr 1fr;
      gap: 20px;
      min-height: 0;
    }

    /* ── COLUMN ── */
    .col {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }
    .colTitle {
      font-size: 13px;
      font-weight: 900;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: var(--muted);
      padding: 0 4px 6px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .colTitle.gold { color: var(--gold); border-color: rgba(255,209,102,.3); }
    .colTitle.accent { color: var(--accent); border-color: rgba(106,228,255,.25); }

    .colMatches {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      overflow: hidden;
    }

    /* ── MATCH CARD ── */
    .matchCard {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: border-color .3s;
      backdrop-filter: blur(8px);
    }
    .matchCard.live {
      border-color: rgba(106,228,255,.45);
      background: rgba(106,228,255,.06);
      box-shadow: 0 0 24px rgba(106,228,255,.12);
    }
    .matchCard.confirmed {
      border-color: rgba(45,255,158,.30);
    }

    .matchLabel {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .8px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .matchTeams {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .teamRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .teamName {
      font-size: 15px;
      font-weight: 800;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }
    .teamName.tbd {
      color: var(--muted);
      font-weight: 500;
      font-style: italic;
    }
    .teamName.winner {
      color: var(--ok);
    }
    .teamScore {
      font-family: var(--mono);
      font-size: 18px;
      font-weight: 900;
      color: var(--text);
      min-width: 24px;
      text-align: right;
    }
    .teamScore.winner { color: var(--ok); }
    .teamScore.loser { color: var(--muted); opacity: .6; }

    .matchDivider {
      height: 1px;
      background: var(--border);
      margin: 1px 0;
    }

    .matchStatus {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }
    .statusDot {
      width: 7px; height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .statusDot.pending  { background: rgba(255,255,255,.25); }
    .statusDot.live     { background: var(--accent); box-shadow: 0 0 8px var(--accent); animation: pulse 1.2s infinite; }
    .statusDot.finished { background: var(--gold); }
    .statusDot.confirmed{ background: var(--ok); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .35; }
    }

    .statusText {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: .3px;
    }
    .setDetails {
      font-size: 11px;
      color: var(--muted);
      margin-left: auto;
      font-family: var(--mono);
    }

    /* ── FINAL/3RD COL SPECIAL ── */
    .col.final .matchCard {
      border-color: rgba(255,209,102,.25);
      background: rgba(255,209,102,.04);
    }

    /* ── PLACE 9 ── */
    .col.place9 .matchCard {
      opacity: .8;
    }
    .col.place9 .teamName { font-size: 13px; }
    .col.place9 .teamScore { font-size: 15px; }

    /* ── NO PLAYOFF ── */
    .noPlayoff {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 28px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: .5px;
    }
  </style>
</head>
<body>
<div class="viewport">
  <div class="header">
    <div class="headerLeft">
      <div class="headerTitle">DRABINKA <span>PLAYOFF</span></div>
      <div class="tournamentBadge" id="slugBadge">—</div>
    </div>
    <div class="headerClock" id="clock">—</div>
  </div>
  <div class="bracketGrid" id="bracketGrid">
    <div class="noPlayoff" id="noPlayoff">Playoff nie został jeszcze wygenerowany.</div>
  </div>
</div>

<script>
(function(){
  // Clock
  const clockEl = document.getElementById("clock");
  function tick(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    if(clockEl) clockEl.textContent = `${hh}:${mm}:${ss}`;
  }
  tick(); setInterval(tick, 1000);

  const U = window.VP_UTIL;
  const ENG = window.VPEngine;
  const STORE = window.VPState;

  const slug = U.qs("t")?.trim();
  if(slug) document.getElementById("slugBadge").textContent = slug.toUpperCase();

  const grid = document.getElementById("bracketGrid");
  const noPlayoff = document.getElementById("noPlayoff");

  let current = null;

  function esc(s){ return String(s||"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function teamName(state, id){
    if(!id) return null;
    return (state.teams||[]).find(x=>x.id===id)?.name || null;
  }

  function buildMatchCard(state, m0){
    if(!m0) return `<div class="matchCard"><div class="teamName tbd">Brak meczu</div></div>`;
    const m = ENG.emptyMatchPatch(m0);
    const status = m.status || "pending";
    const sum = ENG.scoreSummary(m);
    const nameA = teamName(state, m.teamAId);
    const nameB = teamName(state, m.teamBId);
    const isFinished = status === "confirmed" || status === "finished";
    const winnerSide = isFinished ? (sum.setsA > sum.setsB ? "a" : sum.setsB > sum.setsA ? "b" : null) : null;

    const label = m.label ? `<div class="matchLabel">${esc(m.label)}</div>` : "";

    function teamRowHtml(name, score, side){
      const isTbd = !name;
      const isW = winnerSide === side;
      const isL = winnerSide && winnerSide !== side && !isTbd;
      return `
        <div class="teamRow">
          <div class="teamName ${isTbd?"tbd":""} ${isW?"winner":""}">${esc(name||"TBD")}</div>
          <div class="teamScore ${isW?"winner":""} ${isL?"loser":""}">${isTbd?"–":score}</div>
        </div>`;
    }

    // set details
    const setDetails = (m.sets||[]).map((s,i)=>{
      const min = i===2?15:25;
      const a = +s.a||0, b = +s.b||0;
      const done = (Math.abs(a-b)>=2) && (a>=min||b>=min);
      return done ? `${a}:${b}` : null;
    }).filter(Boolean).join(" · ");

    return `
      <div class="matchCard ${status}">
        ${label}
        <div class="matchTeams">
          ${teamRowHtml(nameA, sum.setsA, "a")}
          <div class="matchDivider"></div>
          ${teamRowHtml(nameB, sum.setsB, "b")}
        </div>
        <div class="matchStatus">
          <div class="statusDot ${status}"></div>
          <div class="statusText">${status==="confirmed"?"zakończony":status==="finished"?"czeka na zatwierdzenie":status==="live"?"NA ŻYWO":"oczekuje"}</div>
          ${setDetails ? `<div class="setDetails">${esc(setDetails)}</div>` : ""}
        </div>
      </div>`;
  }

  function buildCol(title, cls, matchIds, byId, state){
    const cards = (matchIds||[]).map(id => buildMatchCard(state, byId.get(id))).join("");
    return `
      <div class="col ${cls||""}">
        <div class="colTitle ${cls==="final"?"gold":cls==="place9"?"":"accent"}">${esc(title)}</div>
        <div class="colMatches">${cards}</div>
      </div>`;
  }

  function render(){
    if(!current) return;
    const state = current.state || {};
    const po = state.playoffs;

    if(!po?.generated){
      grid.innerHTML = `<div class="noPlayoff">Playoff nie został jeszcze wygenerowany.</div>`;
      return;
    }

    const byId = new Map((state.matches||[]).map(m=>[m.id,m]));
    const br = po.bracket || {};

    let html = "";

    // Col 1: QF
    if((br.qf||[]).length){
      html += buildCol("Ćwierćfinały", "qf", br.qf, byId, state);
    }

    // Col 2: SF
    if((br.sf||[]).length){
      html += buildCol("Półfinały", "sf", br.sf, byId, state);
    }

    // Col 3: Final + 3rd
    const finIds = [br.final, br.third].filter(Boolean);
    const finTitles = {[br.final]:"Finał", [br.third]:"Mecz o 3. miejsce"};
    if(finIds.length){
      const cards = finIds.map(id => {
        const m = byId.get(id);
        return `<div style="margin-bottom:10px"><div class="colTitle gold" style="font-size:11px;margin-bottom:8px">${esc(finTitles[id]||"")}</div>${buildMatchCard(state,m)}</div>`;
      }).join("");
      html += `<div class="col final"><div class="colTitle gold">Finał &amp; Medale</div><div class="colMatches">${cards}</div></div>`;
    }

    // Col 4: Place 9-12
    if((br.place9||[]).length){
      html += buildCol("Miejsca 9–12", "place9", br.place9, byId, state);
    }

    grid.innerHTML = html;
  }

  async function init(){
    if(!slug){
      grid.innerHTML = `<div class="noPlayoff">Brak parametru ?t=slug</div>`;
      return;
    }
    current = await STORE.fetchState(slug);
    render();
    STORE.subscribeState(slug, snap => {
      current = { tournamentId: snap.tournamentId, version: snap.version, state: snap.state };
      render();
    });
  }

  init().catch(e => {
    grid.innerHTML = `<div class="noPlayoff">Błąd: ${e.message||e}</div>`;
  });
})();
</script>
</body>
</html>
